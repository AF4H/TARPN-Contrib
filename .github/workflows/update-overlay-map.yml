name: Update overlay-map.cfg

on:
  push:
    paths:
      - 'rpi-oem/overlays/**'
      - '.github/workflows/update-overlay-map.yml'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-overlay-map:
    runs-on: ubuntu-latest
    # Avoid infinite loops: don't regenerate when *we* just pushed overlay-map.cfg
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate overlay-map.cfg
        run: |
          set -euo pipefail

          REPO_ROOT="$(pwd)/rpi-oem"
          OVERLAY_ROOT="${REPO_ROOT}/overlays"
          MAP_FILE="${OVERLAY_ROOT}/overlay-map.cfg"
          CONTRIB_FILE="${OVERLAY_ROOT}/overlay-map-contrib.cfg"

          # Derive GitHub Pages base URL from repo owner/name
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          BASE_URL="https://${OWNER}.github.io/${REPO_NAME}"

          tmp="${MAP_FILE}.tmp"

          {
            echo "# overlay-map.cfg"
            echo "# AUTO-GENERATED by .github/workflows/update-overlay-map.yml"
            echo "# Repo overlays -> GitHub Pages URLs, followed by contributed entries."
            echo
            echo "# ----------------------------------------------------------------------"
            echo "# Repo overlays (from rpi-oem/overlays/*/*)"
            echo "# ----------------------------------------------------------------------"
          } > "$tmp"

          # Generate entries for each two-level dir rpi-oem/overlays/<ns>/<name>
          for dir in "${OVERLAY_ROOT}"/*/*; do
            [ -d "$dir" ] || continue
            ns="$(basename "$(dirname "$dir")")"
            name="$(basename "$dir")"
            key="${ns}/${name}"
            url="${BASE_URL}/overlays/${ns}/${name}.zip"
            echo "${key}=${url}" >> "$tmp"
          done

          echo >> "$tmp"
          echo "# ----------------------------------------------------------------------" >> "$tmp"
          echo "# Contributed / external overlays (from overlay-map-contrib.cfg)" >> "$tmp"
          echo "# ----------------------------------------------------------------------" >> "$tmp"

          if [ -f "$CONTRIB_FILE" ]; then
            cat "$CONTRIB_FILE" >> "$tmp"
          else
            echo "# (no overlay-map-contrib.cfg present)" >> "$tmp"
          fi

          mv "$tmp" "$MAP_FILE"

          echo "[update-overlay-map] Regenerated ${MAP_FILE}"

      - name: Commit and push overlay-map.cfg if changed
        run: |
          set -euo pipefail

          if git status --porcelain rpi-oem/overlays/overlay-map.cfg | grep .; then
            echo "[update-overlay-map] overlay-map.cfg changed; committing..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add rpi-oem/overlays/overlay-map.cfg
            git commit -m "Update overlay-map.cfg (auto-generated)" || exit 0
            git push
          else
            echo "[update-overlay-map] No changes to overlay-map.cfg; nothing to commit."
          fi
